include ./../Makefile.extern
SHELL = /bin/sh
.SUFFIXES: .cc .o

LULESH_EXEC   = lulesh_cd_profile
#TEST_EXEC     = test_profiler
TEST_EXEC     = test_mpi_profiler
EXEC_PROFILED = $(LULESH_EXEC)

#MPI_INC = /opt/local/include/openmpi
#MPI_LIB = /opt/local/lib

SERCXX   = c++ -DUSE_MPI=0 -DCDNODE_VIZ=1
MPICXX   = mpic++ -DUSE_MPI=1 -DCDNODE_VIZ=1
CXX      = $(MPICXX)
CXXFLAGS = -g -std=c++11 -openmp -I${SILO_INCDIR} -Wall -Wno-pragmas ${SIGHT_CFLAGS} ${CD_PROFILER_CFLAGS}
LDFLAGS  = ${SIGHT_LDFLAGS} ${SIGHT_LINKFLAGS} ${CD_PROFILER_LINKFLAGS}

#SILO_INCDIR = /usr/gapps/silo/current/chaos_5_x86_64/include
#SILO_LIBDIR = /usr/gapps/silo/current/chaos_5_x86_64/lib
#CXXFLAGS    = ${CXXFLAGS} -DVIZ_MESH -I${SILO_INCDIR} 
#LDFLAGS     = ${LDFLAGS} -L${SILO_LIBDIR} -Wl,-rpath -Wl,${SILO_LIBDIR} -lsiloh5 -lhdf5

SOURCE_LULESH = \
	./lulesh_v2/lulesh.cc \
	./lulesh_v2/lulesh-comm.cc \
	./lulesh_v2/lulesh-viz.cc \
	./lulesh_v2/lulesh-util.cc \
	./lulesh_v2/lulesh-init.cc
SOURCE_TEST        = ./test_mpi_profiler/mpi_profiler_test.cc
#SOURCE_CD_PROFILER = ${CD_PROFILER}/src/*.cc

LULESH_O      = $(SOURCE_LULESH:.cc=.o)
TEST_O        = $(SOURCE_TEST:.cc=.o)
#CD_PROFILER_O = $(SOURCE_CD_PROFILER:.cc=.o)

sight_H :=  ${SIGHT_ROOT}/*.h \
            ${SIGHT_ROOT}/*/*.h \
            ${SIGHT_ROOT}/widgets/*/*.h \
            ${SIGHT_ROOT}/libsight_structure.so

cd_profiler_H := ${CD_PROFILER}/src/*.h \
                 ${CD_PROFILER}/lib/cd_profiler.so
all_H        := ${sight_H} ${cd_profiler_H}

.cc.o: all_H 
	@echo "\nBuilding $<"
	$(CXX) -c $(CXXFLAGS) -o $@ $<

all: $(EXEC_PROFILED)

lulesh_cd_profile: $(LULESH_O) $(CD_PROFILER_O) 
	@echo "\nLinking"
	$(CXX) -o $@ $^ $(LDFLAGS) -lm

test_cd_profile: $(TEST_O) $(CD_PROFILER_O) 
	@echo "\nLinking"
	$(CXX) -o $@ $^ $(LDFLAGS) -lm

clean:
	rm -rf ${CD_APP}/lulesh_v2/*.dSYM ./lulesh_v2/*.o
	rm -rf test_cd_profile; rm -rf lulesh_cd_profile;  
	rm -rf ${CD_APP}/dbg*; 
	rm -rf ${CD_APP}/profile_data/*; 
